<!DOCTYPE html>
<html lang="pt-br">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Checkout - PIX</title>
  <link rel="icon" type="image/png" href="../assets/icons/xd.png" />
  <link rel="stylesheet" href="../css/reset.css" />
  <link rel="stylesheet" href="../css/base.css" />
  <link rel="stylesheet" href="../css/components.css" />
  <link rel="stylesheet" href="../css/theme.css" />
  <style>
    html, body { background: var(--bg); color: var(--text); }
    .checkout-container { max-width: 960px; margin: 2rem auto; padding: 1.25rem; }
    .card { background: var(--surface); border: 2px solid var(--primary); border-radius: 12px; box-shadow: 0 6px 24px rgba(106,13,173,.25); padding: 1.25rem; color: var(--text); }
    .card h1 { font-size: 1.5rem; margin: 0 0 1rem; }
    .grid { display: grid; gap: 1rem; grid-template-columns: 1fr; }
    @media (min-width: 900px) { .grid { grid-template-columns: 1.2fr .8fr; } }
    .muted { color: var(--muted); font-size: .95rem; }

    .qr-wrap { display: grid; gap: .75rem; place-items: center; text-align: center; }
    .qr-box { background: var(--surface); border: 1px solid var(--primary); border-radius: 12px; padding: 1rem; width: 290px; }
    canvas#XD-STORE-2001 { display: block; width: 256px; height: 256px; margin: 0 auto; }
    .key { font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace; font-size: .95rem; word-break: break-all; background: var(--bg-2); color: var(--text); padding: .75rem; border-radius: 8px; }

    .row { display: flex; gap: .5rem; align-items: center; }
    .row .grow { flex: 1; }
    .btn { cursor: pointer; border: 0; border-radius: 10px; padding: .65rem .9rem; background: var(--primary); color: #fff; }
    .btn.secondary { background: var(--primary-2); }

    .summary { background: var(--bg-2); color: var(--text); border-radius: 12px; padding: 1rem; }
    .summary h2 { margin-top: 0; font-size: 1.1rem; }
    .summary .line { display: flex; justify-content: space-between; padding: .35rem 0; border-bottom: 1px dashed rgba(255,255,255,.12); }
    .summary .line:last-child { border-bottom: 0; }

    .badge { display:inline-block; font-size:.8rem; padding:.2rem .5rem; border-radius: 999px; background: var(--surface); color: var(--text); border: 1px solid var(--primary); }
    .error { background: #3f1a1a; color:#FCA5A5; }
    .success { background:#1b1530; color:#C4B5FD; }

    /* mensagem de erro ao gerar QR */
    .qr-error { color: var(--muted); padding: 12px; text-align: center; }

    /* estados desabilitados para bot칫es */
    .btn[disabled] { opacity: 0.6; pointer-events: none; filter: grayscale(35%); }
  </style>
</head>
<body>
  <button id="theme-toggle" aria-label="Alternar tema" class="support-button theme-toggle" style="position:fixed;top:12px;right:12px;z-index:4000;">游깹</button>
  <div class="checkout-container">
    <div class="card">
      <h1>Pagamento via PIX</h1>
      <p class="muted">Finalize seu pedido utilizando PIX. Um c칩digo QR e o c칩digo copia e cola ser칚o gerados abaixo.</p>

      <div class="grid">
        <section class="qr-wrap">
          <div class="qr-box">
            <div id="XD-STORE-2001" aria-label="QR Code PIX"></div>
          </div>
          <div class="row">
            <div class="grow key" id="XD-STORE-2002" tabindex="0" aria-label="C칩digo PIX copia e cola"></div>
            <button class="btn" id="XD-STORE-2003" aria-label="Copiar c칩digo PIX">Copiar</button>
          </div>
          <div class="row">
            <div class="grow key" id="XD-STORE-2004" aria-label="ID do pedido"></div>
            <button class="btn secondary" id="XD-STORE-2005" aria-label="Copiar ID do pedido">Copiar</button>
          </div>
          <div id="XD-STORE-2006" class="badge" role="status" aria-live="polite" style="display:none"></div>
          <div class="row">
            <button class="btn secondary" id="XD-STORE-2011" aria-label="J치 paguei">J치 paguei</button>
          </div>
        </section>

        <aside class="summary" aria-label="Resumo do pedido">
          <h2>Resumo</h2>
          <div class="line"><span>Itens</span><strong id="XD-STORE-2007">0</strong></div>
          <div class="line"><span>Subtotal</span><strong id="XD-STORE-2008">R$ 0,00</strong></div>
          <div class="line coupon-line">
            <input type="text" id="coupon-input" placeholder="C칩digo do cupom" />
            <button class="btn secondary" id="apply-coupon">Aplicar</button>
            <button class="btn secondary" id="remove-coupon" style="display:none;">Remover</button>
          </div>
          <div class="line" id="discount-line" style="display:none;"><span>Desconto</span><strong id="XD-STORE-2009">-R$ 0,00</strong></div>
          <div class="line"><span>Total</span><strong id="XD-STORE-2010">R$ 0,00</strong></div>
          <p class="muted" style="margin-top:.75rem">O QR Code expira em 30 minutos. Ap칩s o pagamento, voc칡 receber치 a confirma칞칚o automaticamente.</p>
        </aside>
      </div>
    </div>
  </div>

  <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
  <script type="module">
    import { getCartTotal, getDiscount, getCartTotalWithDiscount, applyCoupon, removeCoupon, getAppliedCoupon } from '../js/store.js';

    // Lista de cupons v치lidos - edite aqui para adicionar/remover cupons
    const VALID_COUPONS = {
      'DESCONTO10': 10,  // 10% de desconto
      'PROMO20': 20,     // 20% de desconto
      'BLACKFRIDAY': 30, // 30% de desconto
      // Adicione mais cupons aqui no formato 'CODIGO': porcentagem
    };

    function validateCoupon(code) {
      return VALID_COUPONS[code.toUpperCase()] ? { code: code.toUpperCase(), percentage: VALID_COUPONS[code.toUpperCase()] } : null;
    }

    // UTIL: moeda BRL
    function toBRL(v){
      try{ return v.toLocaleString('pt-BR',{style:'currency',currency:'BRL'});}catch{ return 'R$ ' + (Number(v)||0).toFixed(2).replace('.',','); }
    }

    // Carrega resumo do carrinho de localStorage
    function loadCartSummary(){
      const raw = localStorage.getItem('cart');
      let cart = [];
      try { cart = raw ? JSON.parse(raw) : []; } catch { cart = []; }
      const subtotal = cart.reduce((acc,i)=> acc + Number(i.price||0) * Number(i.qty||1), 0);
      const discount = getDiscount(subtotal);
      const total = subtotal - discount;
      document.getElementById('XD-STORE-2007').textContent = String(cart.reduce((a,i)=>a+Number(i.qty||1),0));
      document.getElementById('XD-STORE-2008').textContent = toBRL(subtotal);
      const discountEl = document.getElementById('XD-STORE-2009');
      const discountLine = document.getElementById('discount-line');
      if (discount > 0) {
        discountEl.textContent = '-' + toBRL(discount);
        discountLine.style.display = 'block';
      } else {
        discountLine.style.display = 'none';
      }
      document.getElementById('XD-STORE-2010').textContent = toBRL(total);
      return { subtotal, total };
    }

    // Gera um ID de pedido curto
    function generateOrderId(){
      const rand = Math.floor(Math.random()*1000000).toString().padStart(6,'0');
      return `XD-STORE-${rand}`;
    }

    // Monta payload PIX copia e cola (EMVCo)
    function buildPixPayload({pixKey, merchantName, merchantCity, txid, amount, message}){
      const ID_PAYLOAD_FORMAT = '00';
      const ID_MERCHANT_ACCOUNT = '26';
      const ID_MERCHANT_GUI = '00';
      const ID_MERCHANT_KEY = '01';
      const ID_MERCHANT_DESCRIPTION = '02';
      const ID_MERCHANT_CATEGORY_CODE = '52';
      const ID_TRANSACTION_CURRENCY = '53';
      const ID_TRANSACTION_AMOUNT = '54';
      const ID_COUNTRY_CODE = '58';
      const ID_MERCHANT_NAME = '59';
      const ID_MERCHANT_CITY = '60';
      const ID_ADDITIONAL_DATA_FIELD = '62';
      const ID_TXID = '05';
      const ID_CRC16 = '63';

      function formatValue(id, value){
        const len = String(value).length.toString().padStart(2,'0');
        return `${id}${len}${value}`;
      }

      const gui = formatValue(ID_MERCHANT_GUI, 'br.gov.bcb.pix');
      const key = formatValue(ID_MERCHANT_KEY, pixKey);
      const desc = message ? formatValue(ID_MERCHANT_DESCRIPTION, message.substring(0,99)) : '';
      const merchantAccountInfo = formatValue(ID_MERCHANT_ACCOUNT, gui + key + desc);

      const merCat = formatValue(ID_MERCHANT_CATEGORY_CODE, '0000');
      const currency = formatValue(ID_TRANSACTION_CURRENCY, '986');
      const amountStr = Number(amount||0).toFixed(2);
      const amountField = Number(amount) > 0 ? formatValue(ID_TRANSACTION_AMOUNT, amountStr) : '';
      const country = formatValue(ID_COUNTRY_CODE, 'BR');
      const name = formatValue(ID_MERCHANT_NAME, merchantName.substring(0,25));
      const city = formatValue(ID_MERCHANT_CITY, merchantCity.substring(0,15));
      const txidField = formatValue(ID_TXID, (txid||'***').substring(0,25));
      const addData = formatValue(ID_ADDITIONAL_DATA_FIELD, txidField);

      let payload = '';
      payload += formatValue(ID_PAYLOAD_FORMAT, '01');
      payload += merchantAccountInfo;
      payload += merCat;
      payload += currency;
      payload += amountField;
      payload += country;
      payload += name;
      payload += city;
      payload += addData;
      payload += ID_CRC16 + '04';

      function crc16(str){
        let crc = 0xFFFF;
        for (let i=0; i<str.length; i++){
          crc ^= str.charCodeAt(i) << 8;
          for (let j=0; j<8; j++){
            if (crc & 0x8000) crc = (crc << 1) ^ 0x1021; else crc <<= 1;
            crc &= 0xFFFF;
          }
        }
        return crc.toString(16).toUpperCase().padStart(4, '0');
      }

      const full = payload + crc16(payload);
      return full;
    }

    // Renderiza QR Code usando QRCode.js (CDN)
    function drawQr(container, text){
      try { container.innerHTML = ''; } catch {}
      try{
        const styles = getComputedStyle(document.documentElement);
        const colorDark = (styles.getPropertyValue('--text') || '#111827').trim();
        const colorLight = (styles.getPropertyValue('--surface') || '#ffffff').trim();
        // prefer high error correction for payment QR codes
        new QRCode(container, { text, width: 256, height: 256, colorDark: colorDark, colorLight: colorLight, correctLevel: QRCode.CorrectLevel.H });
        // give the generated element a stable id for styling/debugging
        const child = container.firstElementChild;
        if (child && !child.id) child.id = 'XD-STORE-2001-canvas';
      }catch(e){
        console.error('QR generation failed', e);
        const fallback = document.createElement('div');
        fallback.className = 'qr-error';
        fallback.textContent = 'Falha ao gerar QR. Use o c칩digo abaixo ou tente novamente.';
        try{ container.appendChild(fallback); }catch{};
        setStatus('Falha ao gerar QR', 'error');
      }
    }

    // QRious minimal inline
    
    function setStatus(msg, kind='success'){
      const el = document.getElementById('XD-STORE-2006');
      el.textContent = msg; el.style.display = 'inline-block';
      el.className = `badge ${kind==='error'?'error':'success'}`;
      setTimeout(()=>{ el.style.display='none'; }, 3000);
    }

    function approveOrder(orderId, total){
      try {
        const raw = localStorage.getItem('lastOrder');
        const last = raw ? JSON.parse(raw) : {};
        if (last && last.orderId === orderId) {
          last.status = 'aprovado';
          last.approvedAt = Date.now();
          localStorage.setItem('lastOrder', JSON.stringify(last));
        }
      } catch (e) { /* noop */ }

      localStorage.removeItem('cart');
      setStatus('Pagamento aprovado! Redirecionando...', 'success');
      setTimeout(()=>{ window.location.href = './sucesso.html'; }, 1200);
    }

    function startPolling(orderId, total){
      setStatus('Aguardando pagamento...', 'success');
      const interval = setInterval(()=>{
        try{
          const approvedIdRaw = localStorage.getItem('paymentApprovedOrderId');
          const approvedId = approvedIdRaw ? JSON.parse(approvedIdRaw) : null;
          if (approvedId && approvedId === orderId){
            clearInterval(interval);
            localStorage.removeItem('paymentApprovedOrderId');
            approveOrder(orderId, total);
          }
        }catch(e){ /* ignore */ }
      }, 3000);
    }

    let currentOrderId = null;

    function generateQrCode(total){
      // se n칚o h치 itens / total 0, n칚o gerar o QR
      if (!total || Number(total) <= 0){
        const container = document.getElementById('XD-STORE-2001');
        try{ container.innerHTML = '<div class="qr-error">Carrinho vazio. Adicione itens antes de gerar o PIX.</div>'; }catch{}
        try{ document.getElementById('XD-STORE-2002').textContent = ''; }catch{}
        try{ document.getElementById('XD-STORE-2003').setAttribute('disabled','disabled'); }catch{}
        try{ document.getElementById('XD-STORE-2011').setAttribute('disabled','disabled'); }catch{}
        setStatus('Carrinho vazio. Adicione itens para gerar o PIX.', 'error');
        return;
      }

      // Config PIX pessoal (ocultar nome/cidade)
      const pixConfig = {
        pixKey: '2809b0f3-e163-4554-9505-47080e1142a4',
        merchantName: '.',
        merchantCity: '.',
      };

      const txid = currentOrderId.replace(/[^A-Z0-9]/g,'').slice(0,25);
      const payload = buildPixPayload({
        pixKey: pixConfig.pixKey,
        merchantName: pixConfig.merchantName,
        merchantCity: pixConfig.merchantCity,
        txid,
        amount: total,
        message: `Pedido ${currentOrderId}`
      });

      document.getElementById('XD-STORE-2004').textContent = currentOrderId;
      const pixEl = document.getElementById('XD-STORE-2002');
      const copiaCola = payload; // copia e cola com EMV completo (igual ao QR)
      pixEl.textContent = copiaCola;
      drawQr(document.getElementById('XD-STORE-2001'), payload);

      // Re-bind copy buttons
      document.getElementById('XD-STORE-2003').addEventListener('click', async ()=>{
        try{ await navigator.clipboard.writeText(copiaCola); setStatus('C칩digo PIX copiado!'); }catch(e){ setStatus('Falha ao copiar PIX', 'error'); }
      });
      document.getElementById('XD-STORE-2005').addEventListener('click', async ()=>{
        try{ await navigator.clipboard.writeText(currentOrderId); setStatus('ID do pedido copiado!'); }catch(e){ setStatus('Falha ao copiar ID', 'error'); }
      });
      document.getElementById('XD-STORE-2011').addEventListener('click', ()=>{
        try{
          localStorage.setItem('paymentApprovedOrderId', JSON.stringify(currentOrderId));
          setStatus('Validando pagamento...', 'success');
        }catch(e){ setStatus('Falha ao sinalizar pagamento', 'error'); }
      });

      localStorage.setItem('lastOrder', JSON.stringify({ orderId: currentOrderId, payload, total, createdAt: Date.now(), status: 'aguardando' }));
      startPolling(currentOrderId, total);
    }

    async function init(){
      const summary = loadCartSummary();
      currentOrderId = generateOrderId();
      generateQrCode(summary.total);

      // Coupon functionality
      const couponInput = document.getElementById('coupon-input');
      const applyCouponBtn = document.getElementById('apply-coupon');
      const removeCouponBtn = document.getElementById('remove-coupon');

      applyCouponBtn.addEventListener('click', () => {
        const code = couponInput.value.trim().toUpperCase();
        if (!code) return;
        const validCoupon = validateCoupon(code);
        if (validCoupon) {
          applyCoupon(code, validCoupon.percentage);
          const summary = loadCartSummary();
          generateQrCode(summary.total);
          couponInput.value = '';
          applyCouponBtn.style.display = 'none';
          removeCouponBtn.style.display = 'inline-block';
          setStatus(`Cupom aplicado! Desconto de ${validCoupon.percentage}%`, 'success');
        } else {
          setStatus('Cupom inv치lido', 'error');
        }
      });

      removeCouponBtn.addEventListener('click', () => {
        removeCoupon();
        const summary = loadCartSummary();
        generateQrCode(summary.total);
        couponInput.value = '';
        applyCouponBtn.style.display = 'inline-block';
        removeCouponBtn.style.display = 'none';
        setStatus('Cupom removido', 'success');
      });

      // Check if coupon is already applied
      const applied = getAppliedCoupon();
      if (applied) {
        couponInput.value = applied.code;
        applyCouponBtn.style.display = 'none';
        removeCouponBtn.style.display = 'inline-block';
      }
    }

    init();

    // Theme init / toggle
    function applyTheme(){ const t = localStorage.getItem('xd-theme') || 'dark'; if (t==='light') document.documentElement.setAttribute('data-theme','light'); else document.documentElement.removeAttribute('data-theme'); }
    document.getElementById('theme-toggle').addEventListener('click', ()=>{ const cur = localStorage.getItem('xd-theme') || 'dark'; const next = cur === 'dark' ? 'light' : 'dark'; localStorage.setItem('xd-theme', next); applyTheme(); });
    applyTheme();
  </script>
</body>
</html>
